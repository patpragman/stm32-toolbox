#ifndef FAMILY_GPIO_H
#define FAMILY_GPIO_H

#include <stdint.h>

{% set gpio_base = {
  "A": "0x48000000",
  "B": "0x48000400",
  "C": "0x48000800",
  "D": "0x48000C00",
  "E": "0x48001000",
  "F": "0x48001400",
  "G": "0x48001800",
  "H": "0x48001C00"
} %}
{% set rcc_bit = {
  "A": 0,
  "B": 1,
  "C": 2,
  "D": 3,
  "E": 4,
  "F": 5,
  "G": 6,
  "H": 7
} %}

#define RCC_BASE 0x40021000U
#define RCC_AHB2ENR_OFFSET 0x4CU
#define RCC_AHB2ENR (*(volatile uint32_t *)(RCC_BASE + RCC_AHB2ENR_OFFSET))

#define GPIO_BASE {{ gpio_base[led_port] }}U
#define GPIO_MODER (*(volatile uint32_t *)(GPIO_BASE + 0x00U))
#define GPIO_ODR (*(volatile uint32_t *)(GPIO_BASE + 0x14U))
#define GPIO_BSRR (*(volatile uint32_t *)(GPIO_BASE + 0x18U))

#define LED_PIN {{ led_pin }}U
#define LED_MASK (1U << LED_PIN)

static inline void gpio_led_init(void)
{
    RCC_AHB2ENR |= (1U << {{ rcc_bit[led_port] }}U);
    GPIO_MODER = (GPIO_MODER & ~(3U << (LED_PIN * 2U))) | (1U << (LED_PIN * 2U));
}

static inline void gpio_led_toggle(void)
{
    if (GPIO_ODR & LED_MASK)
    {
        GPIO_BSRR = (LED_MASK << 16U);
    }
    else
    {
        GPIO_BSRR = LED_MASK;
    }
}

#endif
