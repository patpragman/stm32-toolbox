#ifndef FAMILY_GPIO_H
#define FAMILY_GPIO_H

#include <stdint.h>

{% set gpio_base = {
  "A": "0x48000000",
  "B": "0x48000400",
  "C": "0x48000800",
  "D": "0x48000C00",
  "E": "0x48001000",
  "F": "0x48001400"
} %}
{% set rcc_bit = {
  "A": 17,
  "B": 18,
  "C": 19,
  "D": 20,
  "E": 21,
  "F": 22
} %}

#define RCC_BASE 0x40021000U
#define RCC_AHBENR_OFFSET 0x14U
#define RCC_AHBENR (*(volatile uint32_t *)(RCC_BASE + RCC_AHBENR_OFFSET))

#define GPIO_BASE {{ gpio_base[led_port] }}U
#define GPIO_MODER (*(volatile uint32_t *)(GPIO_BASE + 0x00U))
#define GPIO_ODR (*(volatile uint32_t *)(GPIO_BASE + 0x14U))
#define GPIO_BSRR (*(volatile uint32_t *)(GPIO_BASE + 0x18U))

#define LED_PIN {{ led_pin }}U
#define LED_MASK (1U << LED_PIN)

static inline void gpio_led_init(void)
{
    RCC_AHBENR |= (1U << {{ rcc_bit[led_port] }}U);
    GPIO_MODER = (GPIO_MODER & ~(3U << (LED_PIN * 2U))) | (1U << (LED_PIN * 2U));
}

static inline void gpio_led_toggle(void)
{
    if (GPIO_ODR & LED_MASK)
    {
        GPIO_BSRR = (LED_MASK << 16U);
    }
    else
    {
        GPIO_BSRR = LED_MASK;
    }
}

#endif
