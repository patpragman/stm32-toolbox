PROJECT := {{ project_name }}
BUILD_DIR ?= build
OUT_DIR ?= out
BUILD_STAMP := $(BUILD_DIR)/.dir
OUT_STAMP := $(OUT_DIR)/.dir
ELF := $(BUILD_DIR)/$(PROJECT).elf
HEX := $(OUT_DIR)/$(PROJECT).hex
BIN := $(OUT_DIR)/$(PROJECT).bin
MAP := $(BUILD_DIR)/$(PROJECT).map

TOOLCHAIN_PREFIX ?= arm-none-eabi-
override CC := $(TOOLCHAIN_PREFIX)gcc
override AS := $(TOOLCHAIN_PREFIX)gcc
override OBJCOPY := $(TOOLCHAIN_PREFIX)objcopy
override SIZE := $(TOOLCHAIN_PREFIX)size
OPENOCD ?= openocd

CPU_FLAGS := -mcpu={{ pack.cpu }} -mthumb
CFLAGS := $(CPU_FLAGS) -Wall -Wextra -Werror -ffreestanding -fno-builtin -ffunction-sections -fdata-sections -O0 -g
ASFLAGS := $(CPU_FLAGS)
LDFLAGS := $(CPU_FLAGS) -T linker.ld -Wl,--gc-sections -Wl,-Map=$(MAP) -nostartfiles
INCLUDES := -I.

SRCS := \
  app_pins.c \
  hal_clock.c \
  hal_delay.c \
  hal_gpio.c \
  hal_uart.c \
  main.c \
  system.c \
  startup_gcc.s

OBJS := $(SRCS:.c=.o)
OBJS := $(OBJS:.s=.o)
OBJS := $(addprefix $(BUILD_DIR)/, $(OBJS))

OPENOCD_CMDS := {{ openocd_commands }}

.PHONY: all build clean flash size

all: $(ELF) $(HEX) $(BIN)

$(BUILD_STAMP):
	mkdir -p $(BUILD_DIR)
	touch $@

$(OUT_STAMP):
	mkdir -p $(OUT_DIR)
	touch $@

$(BUILD_DIR)/%.o: %.c | $(BUILD_STAMP)
	$(CC) $(CFLAGS) $(INCLUDES) -c $< -o $@

$(BUILD_DIR)/%.o: %.s | $(BUILD_STAMP)
	$(AS) $(ASFLAGS) -c $< -o $@

$(ELF): $(OBJS)
	$(CC) $(OBJS) $(LDFLAGS) -o $@

$(HEX): $(ELF) | $(OUT_STAMP)
	$(OBJCOPY) -O ihex $< $@

$(BIN): $(ELF) | $(OUT_STAMP)
	$(OBJCOPY) -O binary $< $@

size: $(ELF)
	$(SIZE) $<

build: all

flash: $(ELF)
	$(OPENOCD) -f {{ openocd_interface_cfg }} -f {{ openocd_target_cfg }} -c "$(OPENOCD_CMDS)"

clean:
	rm -rf $(BUILD_DIR) $(OUT_DIR)
